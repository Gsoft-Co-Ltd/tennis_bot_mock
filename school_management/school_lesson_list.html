<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>イベント管理</title>
  <!-- Bootstrap 5 CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  >
  <style>
    body {
      background-color: #f5f7fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      margin-top: 40px;
    }
    .form-inline-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .form-inline-container .form-label {
      margin: 0;
      font-weight: 600;
      white-space: nowrap;
    }
    .form-inline-container .form-select {
      max-width: 150px;
      font-size: 0.9rem;
    }
    .form-inline-container .btn {
      font-size: 0.9rem;
      padding: 6px 12px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h3 class="mb-4">イベント管理</h3>

    <!-- ▼▼▼ 企業・スクール選択 ▼▼▼ -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row align-items-center gx-2">
          <!-- 企業選択 -->
          <div class="col-auto">
            <div class="form-inline-container">
              <label for="companySelect" class="form-label">企業</label>
              <select id="companySelect" class="form-select form-select-sm">
                <option value="1" selected>株式会社A</option>
                <option value="2">株式会社B</option>
                <option value="3">株式会社C</option>
              </select>
            </div>
          </div>
          <!-- スクール選択 -->
          <div class="col-auto">
            <div class="form-inline-container">
              <label for="schoolSelect" class="form-label">スクール</label>
              <select id="schoolSelect" class="form-select form-select-sm">
                <option value="10" selected>東京スクール</option>
                <option value="20">大阪スクール</option>
                <option value="30">福岡スクール</option>
              </select>
            </div>
          </div>
          <!-- 選択ボタン -->
          <div class="col-auto">
            <button id="selectButton" class="btn btn-primary btn-sm">選択</button>
          </div>
        </div>
      </div>
    </div>
    <!-- 企業・スクール選択 ここまで -->

    <!-- 年月フィルタ -->
    <div class="mb-4">
      <label for="monthFilter" class="form-label">表示する年月:</label>
      <select id="monthFilter" class="form-select" style="max-width: 200px;">
        <option value="all" selected>すべての年月</option>
        <option value="2024-12">2024年12月</option>
        <option value="2025-01">2025年1月</option>
      </select>
    </div>

    <!-- イベント追加ボタン -->
    <button class="btn btn-success mb-3" id="openAddModalBtn">
      イベント追加
    </button>

    <!-- イベント一覧テーブル -->
    <table class="table table-striped table-hover" id="eventTable">
      <thead>
        <tr>
          <th scope="col">日付</th>
          <th scope="col">イベント名</th>
          <th scope="col">コート</th>
          <th scope="col">追加料金</th>
          <th scope="col">開始時間</th>
          <th scope="col">終了時間</th>
          <th scope="col">定員</th>
          <th scope="col">説明</th>
          <th scope="col">操作</th>
        </tr>
      </thead>
      <tbody>
        <!-- サンプルデータ: data-id="イベントID" や data-month="YYYY-MM" -->
        <tr 
          data-id="101" 
          data-month="2024-12"
          data-date="2024-12-25"
          data-name="年末特別レッスン"
          data-court="102"
          data-fee="1000"
          data-start="12:00"
          data-end="14:00"
          data-capacity="15"
          data-desc="年末に集中ラリー練習"
        >
          <td>2024-12-25</td>
          <td>年末特別レッスン</td>
          <td>コートB</td>
          <td>1000</td>
          <td>12:00</td>
          <td>14:00</td>
          <td>15</td>
          <td>年末に集中ラリー練習</td>
          <td>
            <button class="btn btn-warning btn-sm edit-button">編集</button>
            <button class="btn btn-danger btn-sm delete-button">削除</button>
          </td>
        </tr>
        <tr
          data-id="102"
          data-month="2025-01"
          data-date="2025-01-05"
          data-name="お正月イベント"
          data-court="103"
          data-fee="1500"
          data-start="10:00"
          data-end="12:00"
          data-capacity="10"
          data-desc="新年初打ちの特別レッスン"
        >
          <td>2025-01-05</td>
          <td>お正月イベント</td>
          <td>コートC</td>
          <td>1500</td>
          <td>10:00</td>
          <td>12:00</td>
          <td>10</td>
          <td>新年初打ちの特別レッスン</td>
          <td>
            <button class="btn btn-warning btn-sm edit-button">編集</button>
            <button class="btn btn-danger btn-sm delete-button">削除</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ▼▼▼ イベント追加・編集モーダル（同じフォームを使う） ▼▼▼ -->
  <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="eventForm">
        <div class="modal-header">
          <h5 class="modal-title" id="eventModalTitle">イベント追加</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- hidden: 編集時はイベントIDをここに入れる -->
          <input type="hidden" name="eventId" id="eventId" value="">

          <div class="mb-3">
            <label for="eventDate" class="form-label">開催日</label>
            <input type="date" id="eventDate" name="eventDate" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="eventName" class="form-label">イベント名</label>
            <input type="text" id="eventName" name="eventName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="courtId" class="form-label">コート</label>
            <select id="courtId" name="courtId" class="form-select" required>
              <option value="">-- 選択してください --</option>
              <!-- 実際にはmst_courtsテーブルから動的に生成など -->
              <option value="101">コートA</option>
              <option value="102">コートB</option>
              <option value="103">コートC</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="additionalFee" class="form-label">追加料金</label>
            <input type="number" id="additionalFee" name="additionalFee" class="form-control" value="0">
          </div>
          <div class="mb-3">
            <label for="startTime" class="form-label">開始時間</label>
            <input type="time" id="startTime" name="startTime" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="endTime" class="form-label">終了時間</label>
            <input type="time" id="endTime" name="endTime" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="capacity" class="form-label">定員</label>
            <input type="number" id="capacity" name="capacity" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="eventDescription" class="form-label">説明</label>
            <textarea id="eventDescription" name="eventDescription" class="form-control" rows="3"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          <button type="submit" class="btn btn-primary" id="saveEventBtn">
            追加
          </button>
        </div>
      </form>
    </div>
  </div>
  <!-- ▼▼▼ モーダルここまで ▼▼▼ -->

  <!-- BootstrapバンドルJS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const monthFilter = document.getElementById('monthFilter');
      const rows = document.querySelectorAll('#eventTable tbody tr');

      // === 月ごとのフィルタリング ===
      function filterEvents() {
        const selectedMonth = monthFilter.value;
        rows.forEach(row => {
          const rowMonth = row.getAttribute('data-month');
          row.style.display = 
            (selectedMonth === 'all' || rowMonth === selectedMonth)
              ? ''
              : 'none';
        });
      }
      monthFilter.addEventListener('change', filterEvents);
      filterEvents(); // 初期表示

      // === 企業・スクール選択 ===
      document.getElementById('selectButton').addEventListener('click', () => {
        const companyId = document.getElementById('companySelect').value;
        const schoolId  = document.getElementById('schoolSelect').value;
        if(!companyId || !schoolId) {
          alert("企業とスクールを選んでください。");
          return;
        }
        // 実際にはサーバーやAPIを呼び出して再描画など
        alert(`企業ID:${companyId} / スクールID:${schoolId} が選択されました(モック)`);
      });

      // === イベントモーダルを操作する要素 ===
      const eventModalElem = document.getElementById('eventModal');
      const eventModal = new bootstrap.Modal(eventModalElem);
      const eventForm = document.getElementById('eventForm');
      const modalTitle = document.getElementById('eventModalTitle');
      const saveEventBtn = document.getElementById('saveEventBtn');

      // === フィールド参照 ===
      const eventIdField = document.getElementById('eventId');
      const eventDateField = document.getElementById('eventDate');
      const eventNameField = document.getElementById('eventName');
      const courtIdField = document.getElementById('courtId');
      const additionalFeeField = document.getElementById('additionalFee');
      const startTimeField = document.getElementById('startTime');
      const endTimeField = document.getElementById('endTime');
      const capacityField = document.getElementById('capacity');
      const descField = document.getElementById('eventDescription');

      // === 「イベント追加」ボタン → 新規作成モードでモーダルを開く ===
      document.getElementById('openAddModalBtn').addEventListener('click', () => {
        // タイトルやボタンを「追加」用に
        modalTitle.textContent = "イベント追加";
        saveEventBtn.textContent = "追加";

        // フィールドをクリア
        eventIdField.value = "";
        eventDateField.value = "";
        eventNameField.value = "";
        courtIdField.value = "";
        additionalFeeField.value = 0;
        startTimeField.value = "";
        endTimeField.value = "";
        capacityField.value = "";
        descField.value = "";

        eventModal.show();
      });

      // === 「編集」ボタン → 編集モードでモーダルを開く ===
      document.querySelectorAll('.edit-button').forEach(editBtn => {
        editBtn.addEventListener('click', (e) => {
          // 押下した行の情報を取得
          const row = e.target.closest('tr');
          const eventId = row.getAttribute('data-id');
          const dateVal = row.getAttribute('data-date');
          const nameVal = row.getAttribute('data-name');
          const courtVal = row.getAttribute('data-court');
          const feeVal = row.getAttribute('data-fee');
          const startVal = row.getAttribute('data-start');
          const endVal = row.getAttribute('data-end');
          const capVal = row.getAttribute('data-capacity');
          const descVal = row.getAttribute('data-desc') || "";

          // タイトルやボタンを「更新」用に
          modalTitle.textContent = "イベント編集";
          saveEventBtn.textContent = "更新";

          // フィールドに既存値をセット
          eventIdField.value = eventId;
          eventDateField.value = dateVal;
          eventNameField.value = nameVal;
          courtIdField.value = courtVal;
          additionalFeeField.value = feeVal;
          startTimeField.value = startVal;
          endTimeField.value = endVal;
          capacityField.value = capVal;
          descField.value = descVal;

          eventModal.show();
        });
      });

      // === 保存ボタン（追加／更新共通） ===
      eventForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const isEdit = !!eventIdField.value;  // eventIdがあれば編集、なければ新規

        if(isEdit) {
          // -- UPDATE 処理例 --
          // ここでAjaxを呼んでUPDATEを行うなど
          // UPDATE dat_events SET
          //   event_date = :eventDate,
          //   event_name = :eventName,
          //   court_id = :courtId,
          //   additional_fee = :additionalFee,
          //   start_time = :startTime,
          //   end_time = :endTime,
          //   capacity = :capacity,
          //   description = :desc
          // WHERE id = :eventId
          alert("イベントを更新しました(モック)");
        } else {
          // -- INSERT 処理例 --
          // INSERT INTO dat_events (...columns...)
          // VALUES (:eventDate, :eventName, ...)
          alert("イベントを追加しました(モック)");
        }

        // モーダルを閉じてフォームをリセット
        eventModal.hide();
        eventForm.reset();
      });

      // === 削除ボタン(論理削除想定) ===
      document.querySelectorAll('.delete-button').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm("このイベントを削除しますか？")) return;
          // 例: UPDATE dat_events SET is_deleted = TRUE WHERE id = ?
          alert("イベントを削除（論理削除）しました(モック)");
        });
      });
    });
  </script>
</body>
</html>
